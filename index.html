<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Stack+Sans+Notch:wght@200..700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
  <div class="main-container">
    <div class="row">
      <div class="col-lg-2">
        <div class="row sidebar">
          <div class="col-lg-12 text-center">
            <a style="text-decoration: none;" href="../index.html">
              <h2 class="logo">FileShare</h2>
            </a>
          </div>
          <div class="divider"></div>
          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(1)"
                style="box-shadow:2px 2px grey;border-radius:10px ;background-color:#e7f3ff;padding-left: 5%; width: 100%;">
                <div class="col-lg-9"><span><i class="fa-solid fa-plus"></i></span> <span
                    style="padding-left: 5%;">NEW</span></div>
                <div id="menu-link-1" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-1" style="display: none;" class="col-lg-10 menu-content">
              <a class="menu-item col-lg-12"
                onclick="window.location.href='file/upload.html?id='+new URLSearchParams(window.location.search).get('id')">
                <span><i class="fa-solid fa-minus "></i> <span style="padding-left: 5%;">Up Load File</span>
              </a>
            </div>
            <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" href="folder/convert.html"
                style="box-shadow:2px 2px grey;border-radius:10px ;background-color:#e7f3ff;padding-left: 5%; width: 100%;">
                <div class="col-lg-9"><span><i class="fa-solid fa-file-export"></i></span> <span
                    style="padding-left: 5%;">Convert Files</span></div>
              </a>
            </div>
          </div>
          </div>
          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(6)">
                <div class="col-lg-9"><span><i class="fa-solid fa-house-laptop"></i></span> <span
                    style="padding-left: 5%;">Home</span></div>
                <div id="menu-link-6" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-6" style="display: none;" class="col-lg-10 menu-content" >
              <a class="menu-item col-lg-12" href="index.html">
                <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">Dashboard</span>
              </a>
            </div>
          </div>

          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(2)">
                <div class="col-lg-9"><span><i class="fa-solid fa-house-laptop"></i></span> <span
                    style="padding-left: 5%;">Folder</span></div>
                <div id="menu-link-2" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-2" style="display: none;" class="col-lg-10 menu-content">
              <div class="row col-lg-12">
                <a href="folder/create.html" class="menu-item col-lg-12">
                  <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">Add New Folder</span>
                </a>
                <a href="folder/all.html" class="menu-item col-lg-12">
                  <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">List All</span>
                </a>
                <a href="folder/shareWithMe.html" class="menu-item col-lg-12">
                  <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">Share With Me</span>
                </a>
                <div class="menu-item col-lg-12">
                  <label>
                    <select id="folderDropdown" class="form-select form-select-sm"
                      onchange="navigateToFolder(this.value)">
                      <option value="">Loading Folder...</option>
                    </select>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(3)">
                <div class="col-lg-9"><span><i class="fa-solid fa-folder-open"></i></span> <span
                    style="padding-left: 5%;">My Folders</span></div>
                <div id="menu-link-3" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-3" style="display: none;" class="col-lg-10 menu-content">


              <div id="folderDropdownList" class="col-lg-12">
                <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                  <i class="fa-solid fa-spinner fa-spin"></i> Loading...
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(4)">
                <div class="col-lg-9"><span><i class="fa-solid fa-folder-open"></i></span> <span
                    style="padding-left: 5%;">Share With Me</span></div>
                <div id="menu-link-4" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-4" style="display: none;" class="col-lg-10 menu-content">


              <div id="sharedFolderDropdownList" class="col-lg-12">
                <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                  <i class="fa-solid fa-spinner fa-spin"></i> Loading...
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(5)">
                <div class="col-lg-9"><span><i class="fa-solid fa-trash"></i></span> <span
                    style="padding-left: 5%;">Trash Bin</span></div>
                <div id="menu-link-5" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-5" style="display: none;" class="col-lg-10 menu-content">
              <div class="row col-lg-12">
                <a href="folder/trash.html" class="menu-item col-lg-12">
                  <span><i class="fa-solid fa-trash-can"></i> <span style="padding-left: 5%;">View Trash</span>
                </a>
              </div>
            </div>
          </div>



        </div>
      </div>
      <div class="col-lg-10 main" style="
            margin-left: 0px;
            margin-right: 0px;
            padding-left: 0px;
            padding-right: 0px;
          ">
        <div class="main-navbar col-lg-12">
          <div class="row align-items-center" style="width: 100%;">
            <div class="col-lg-6">
              <div class="row align-items-center">
                <div class="col-lg-1"><i style="font-size: 20px;" class="fa-solid fa-bars"></i></div>
                <div class="col-lg-7">
                  <div class="input-group">
                    <span class="input-group-text" id="basic-addon1" style="background-color:white;"><i
                        class="fa-solid fa-magnifying-glass"></i></span>
                    <input type="text" class="form-control" placeholder="Search" aria-label="Search"
                      aria-describedby="basic-addon1">
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="d-flex justify-content-end align-items-center" style="padding-right: 20px;">
                <div class="dropdown">
                  <button class="btn btn-light dropdown-toggle" type="button" id="userMenuDropdown"
                    data-bs-toggle="dropdown" aria-expanded="false"
                    style="border-radius: 50px; padding: 8px 20px; border: 1px solid #ddd;">
                    <i class="fa-solid fa-user-circle" style="font-size: 20px; margin-right: 8px; color: #0d6efd;"></i>
                    <span id="username-display" style="font-weight: 500;">User</span>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userMenuDropdown"
                    style="min-width: 200px;">
                    <li>
                      <a class="dropdown-item" href="#" onclick="changePassword(); return false;">
                        <i class="fa-solid fa-key" style="margin-right: 8px;"></i> Change Password
                      </a>
                    </li>
                    <li>
                      <hr class="dropdown-divider">
                    </li>
                    <li>
                      <a class="dropdown-item text-danger" href="#" onclick="logout(); return false;">
                        <i class="fa-solid fa-right-from-bracket" style="margin-right: 8px;"></i> Logout
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row main-container"
          style="padding:20px;border-radius:20px ;width: 98%;min-height: 600px;background-color: white;margin-top:100px;margin-left: 10px;margin-right: 10px;margin-bottom: 20px;">
          <div class="col-lg-12 row">
            <h2 class="content-title">Dashboard</h2>
          </div>
          <div class="col-lg-12 row" style="margin-top:20px;">
            <div id="folder-list" class="row">
              <!-- Folders will be displayed here -->
              <div class="dashboard-summary text-center row "
                style=" background-color: rgb(226, 225, 225); padding: auto;">
                <div class="dashboard-holder row justify-content-between">
                  <h2 class="dashboard-title col-lg-12 ">Welcome to FileShare Dashboard</h2>
                  <div class="dashboard-item num-my-folder col-lg-5 row" style="background-color: #FFFFFF;">
                    <div class="icon col-lg-4" style="margin-top: 30px; margin-right: 10px;">

                      <span
                        style="background-color: rgb(64, 78, 181); padding: 20px;border-radius: 90px;border: 10px solid #DEEEFA;">
                        <i class="fa-brands fa-dropbox"></i></span>


                    </div>
                    <div class="text col-lg-8 row" style="background-color: #FFFFFF;">
                      <div class="number col-lg-12"
                        style="text-align: left; color: black; margin-top: 20px; height: 20px;">
                        <h2 id="myFolderCount" style="margin-bottom: 2px;">
                          <i class="fa-solid fa-spinner fa-spin"></i>
                        </h2>
                      </div>
                      <div class="label col-lg-12" style="text-align: left; color: black;">
                        <p>My Folders</p>
                      </div>
                    </div>
                    <div class="progress col-lg-12" role="progressbar" aria-label="Default striped example"
                      aria-valuenow="10" aria-valuemin="0" aria-valuemax="100">
                      <div class="progress-bar progress-bar-striped" style="width: 10%"></div>
                    </div>
                    <div class="view-all-btn col-lg-12">
                      <a href="../folder/all.html" class="btn btn-light"
                        style="margin-top: 20px; margin-left: 10px; border-radius: 20px; box-shadow: 2px 2px grey;">View
                        All</a>
                    </div>
                  </div>

                  <div class="dashboard-item num-share-with-me col-lg-5 row" style="background-color: #FFFFFF;">
                    <div class="icon col-lg-4" style="margin-top: 30px; margin-right: 10px;">

                      <span
                        style="background-color: rgb(64, 78, 181); padding: 20px;border-radius: 90px;border: 10px solid #DEEEFA;">
                        <i class="fa-solid fa-share-nodes"></i></span>


                    </div>
                    <div class="text col-lg-8 row" style="background-color: #FFFFFF;">
                      <div class="number col-lg-12"
                        style="text-align: left; color: black; margin-top: 20px; height: 20px;">
                        <h2 id="sharedWithMeCount">
                          <i class="fa-solid fa-spinner fa-spin"></i>
                        </h2>
                      </div>
                      <div class="label col-lg-12" style="text-align: left; color: black; ">
                        <p>Shared With Me</p>
                      </div>
                    </div>
                    <div class="progress col-lg-12" role="progressbar" aria-label="Default striped example"
                      aria-valuenow="10" aria-valuemin="0" aria-valuemax="100">
                      <div class="progress-bar progress-bar-striped" style="width: 10%"></div>
                    </div>
                    <div class="view-all-btn col-lg-12">
                      <a href="../folder/shareWithMe.html" class="btn btn-light"
                        style="margin-top: 20px; margin-left: 10px; border-radius: 20px; box-shadow: 2px 2px grey;">View
                        All</a>
                    </div>
                    
                  </div>
                </div>

                
                <div class="col-lg-12 mt-4">
                  <div class="row">
                    <div class="col-lg-6 mb-4">
                      <div class="card" style="background-color: #FFFFFF; padding: 20px; border-radius: 10px;">
                        <h5 class="text-center mb-3">Folder Statistics - Bar Chart</h5>
                        <canvas id="folderBarChart"></canvas>
                      </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                      <div class="card" style="background-color: #FFFFFF; padding: 20px; border-radius: 10px;">
                        <h5 class="text-center mb-3">Folder Statistics - Pie Chart</h5>
                        <canvas id="folderPieChart"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>


      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"
    integrity="sha512-+k1pnlgt4F1H8L7t3z95o3/KO+o78INEcXTbnoJQ/F2VqDVhWoaiVml/OEHv9HsVgxUaVW+IbiZPUJQfF/YxZw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
    integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/js/all.min.js"
    integrity="sha512-6BTOlkauINO65nLhXhthZMtepgJSghyimIalb+crKRPhvhmsCdnIuGcVbR5/aQY2A+260iC1OPy1oCdB6pSSwQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    function showMenu(id) {
      let dropdown = document.getElementById("menu-link-" + id);
      let status = dropdown.dataset.status;
      if (status == 0) {
        document.getElementById("menu-link-" + id).innerHTML = '<i  class="fa-solid fa-angles-down"></i>';
        document.getElementById("menu-link-" + id).dataset.status = 1
        document.getElementById("menu-content-" + id).style.display = "flex";

      }
      else {
        document.getElementById("menu-link-" + id).innerHTML = '<i  class="fa-solid fa-angles-right"></i>'
        document.getElementById("menu-link-" + id).dataset.status = 0
        document.getElementById("menu-content-" + id).style.display = "none";
      }
    }

    window.onload = async function () {
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "../login.html";
        return;
      }

      let checkedToken = await checkToken(token);
      if (!checkedToken) {
        window.location.href = "../login.html";
        return;
      }
      await loadFoldersToDropdown();
      await loadShareFoldersToDropdown();
      await updateDashboardCounts();
      // await GetAllFolder();
    };

    async function loadShareFoldersToDropdown() {
      try {
        const token = localStorage.getItem("token");
        const dropdownList = document.getElementById("sharedFolderDropdownList");
        if (!dropdownList) return;

        const response = await fetch("http://localhost:5025/api/Folder/GetFolderByPermission", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        if (response.ok) {
          const folders = await response.json();

          dropdownList.innerHTML = "";

          if (folders && folders.length > 0) {
            const urlParams = new URLSearchParams(window.location.search);
            const currentFolderId = urlParams.get('id');

            folders.forEach(folder => {
              const isActive = currentFolderId === folder.id;
              const folderItem = document.createElement("a");
              folderItem.href = `../file/allFleInFolder.html?id=${folder.id}`;
              folderItem.className = "menu-item";
              folderItem.style.cssText = isActive
                ? "display: block; width: 100%; background-color: #e7f3ff; border-left: 3px solid #0d6efd; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;"
                : "display: block; width: 100%; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;";

              folderItem.innerHTML = `
                <i class="fa-solid fa-folder" style="color: ${isActive ? '#0d6efd' : '#666'}; font-size: 12px;"></i> 
                <span style="padding-left: 8px; font-size: 13px;">${folder.name || 'Unnamed Folder'}</span>
              `;

              dropdownList.appendChild(folderItem);
            });
          } else {
            dropdownList.innerHTML = `
              <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                <i class="fa-solid fa-folder-open"></i> No shared folders yet
              </div>
            `;
          }
        } else {
          dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Failed to load
            </div>
          `;
          console.error("Failed to load shared folders:", response.status);
        }
      } catch (error) {
        console.error("Error loading shared folders to dropdown:", error);
        const dropdownList = document.getElementById("sharedFolderDropdownList");
        if (dropdownList) {
          dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Error loading
            </div>
          `;
        }
      }
    }
    async function loadFoldersToDropdown() {
      try {
        const token = localStorage.getItem("token");
        const dropdownList = document.getElementById("folderDropdownList");

        if (!dropdownList) return;

        const response = await fetch("http://localhost:5025/api/Folder", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        if (response.ok) {
          const folders = await response.json();

          dropdownList.innerHTML = "";

          if (folders && folders.length > 0) {
            const urlParams = new URLSearchParams(window.location.search);
            const currentFolderId = urlParams.get('id');

            folders.forEach(folder => {
              const isActive = currentFolderId === folder.id;
              const folderItem = document.createElement("a");
              folderItem.href = `../file/allFleInFolder.html?id=${folder.id}`;
              folderItem.className = "menu-item";
              folderItem.style.cssText = isActive
                ? "display: block; width: 100%; background-color: #e7f3ff; border-left: 3px solid #0d6efd; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;"
                : "display: block; width: 100%; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;";

              folderItem.innerHTML = `
                <i class="fa-solid fa-folder" style="color: ${isActive ? '#0d6efd' : '#666'}; font-size: 12px;"></i> 
                <span style="padding-left: 8px; font-size: 13px;">${folder.name || 'Unnamed Folder'}</span>
              `;

              dropdownList.appendChild(folderItem);
            });
          } else {
            dropdownList.innerHTML = `
              <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                <i class="fa-solid fa-folder-open"></i> No folders yet
              </div>
            `;
          }
        } else {
          dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Failed to load
            </div>
          `;
          console.error("Failed to load folders:", response.status);
        }
      } catch (error) {
        console.error("Error loading folders to dropdown:", error);
        const dropdownList = document.getElementById("folderDropdownList");
        if (dropdownList) {
          dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Error loading
            </div>
          `;
        }
      }
    }


    async function checkToken(token) {
      let url = "http://localhost:5025/api/Account/CheckToken";
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
        body: null,
      });
      if (response.ok) {
        return true;
      } else {
        return false;
      }
    }

    // async function GetAllFolder() {
    //   try {
    //     const token = localStorage.getItem("token");
    //     if (!token) {
    //       window.location.href = "../login.html";
    //       return;
    //     }
    //     let url = "http://localhost:5025/api/Folder";
    //     const response = await fetch(url, {
    //       method: "GET",
    //       headers: {
    //         "Content-Type": "application/json",
    //         Authorization: "Bearer " + token,
    //       },
    //     });

    //     const folderListContainer = document.getElementById("folder-list");

    //     if (response.ok) {
    //       const folders = await response.json();

    //       // Clear loading spinner
    //       folderListContainer.innerHTML = "";

    //       if (folders && folders.length > 0) {
    //         folders.forEach(folder => {
    //           const folderCard = `
    //               <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
    //                 <div class="card h-100" style="cursor: pointer; width: 100%; ">
    //                   <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #f8f9fa; padding: 10px 15px;">
    //                     <small class="text-truncate" style="flex: 1; text-align: left; font-weight: 500;">${folder.name}</small>

    //                     <button class="btn btn-light btn-sm ms-2" type="button" id="userMenuDropdown" 
    //                       data-bs-toggle="dropdown" aria-expanded="false" style="padding: 2px 8px;">
    //                       <i class="fa-solid fa-ellipsis-vertical"></i>


    //                     </button>
    //                     <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userMenuDropdown"
    //                           style="min-width: 200px;">
    //                           <li>
    //                             <a class="dropdown-item" href="#" onclick="deleteFolder('${folder.id}', '${folder.name}'); return false;">
    //                               <i class="fa-solid fa-trash" style="margin-right: 8px;"></i> Move to Trash
    //                             </a>
    //                           </li>
    //                           <li>
    //                             <hr class="dropdown-divider">
    //                           </li>
    //                           <li>
    //                             <a class="dropdown-item text-primary" href="#" onclick="shareFolder('${folder.id}', '${folder.name}'); return false;">
    //                               <i class="fa-solid fa-share-nodes" style="margin-right: 8px;"></i> Share
    //                             </a>
    //                           </li>
    //                         </ul>
    //                   </div>
    //                   <div class="card-body"  href="#" onclick="openFolder('${folder.id}'); return false;">
    //                     <div class="text-center mb-3">
    //                       <i class="fa-solid fa-folder" style="font-size: 48px; color: #0d6efd;"></i>
    //                     </div>
    //                     <h5 class="card-title text-center">${folder.name || 'Unnamed Folder'}</h5>
    //                   </div>

    //                 </div>
    //               </div>
    //             `;
    //           folderListContainer.innerHTML += folderCard;
    //         });
    //       } else {
    //         // No folders found
    //         folderListContainer.innerHTML = `
    //             <div class="col-lg-12 text-center" style="padding: 50px;">
    //               <i class="fa-solid fa-folder-open" style="font-size: 64px; color: #ccc;"></i>
    //               <h4 class="mt-3 text-muted">No folders found</h4>
    //               <p class="text-muted">Create your first folder to get started</p>
    //               <a href="create.html" class="btn btn-primary mt-3">
    //                 <i class="fa-solid fa-folder-plus"></i> Create New Folder
    //               </a>
    //             </div>
    //           `;
    //       }
    //     } else {
    //       let errorMessage = "Failed to load folders";

    //       if (response.status === 401) {
    //         toastr.error("Session expired. Please login again.");
    //         setTimeout(() => {
    //           window.location.href = "../login.html";
    //         }, 2000);
    //         return;
    //       } else if (response.status === 404) {
    //         errorMessage = "API endpoint not found";
    //       }

    //       folderListContainer.innerHTML = `
    //           <div class="col-lg-12 text-center" style="padding: 50px;">
    //             <i class="fa-solid fa-exclamation-triangle" style="font-size: 64px; color: #dc3545;"></i>
    //             <h4 class="mt-3 text-danger">${errorMessage}</h4>
    //             <button class="btn btn-primary mt-3" onclick="GetAllFolder()">
    //               <i class="fa-solid fa-refresh"></i> Retry
    //             </button>
    //           </div>
    //         `;
    //       toastr.error(errorMessage);
    //     }
    //   } catch (error) {
    //     console.error("Error loading folders:", error);
    //     const folderListContainer = document.getElementById("folder-list");
    //     folderListContainer.innerHTML = `
    //         <div class="col-lg-12 text-center" style="padding: 50px;">
    //           <i class="fa-solid fa-exclamation-triangle" style="font-size: 64px; color: #dc3545;"></i>
    //           <h4 class="mt-3 text-danger">Network Error</h4>
    //           <p class="text-muted">Please check your connection and try again</p>
    //           <button class="btn btn-primary mt-3" onclick="GetAllFolder()">
    //             <i class="fa-solid fa-refresh"></i> Retry
    //           </button>
    //         </div>
    //       `;
    //     toastr.error("Failed to load folders. Please try again.");
    //   }
    // }


    function openFolder(folderId) {
      if (!folderId) {
        toastr.error("Invalid folder ID");
        return;
      }
      // Redirect to file list page for this folder
      window.location.href = `../file/allFleInFolder.html?id=${folderId}`;
    }

    async function deleteFolder(folderId, folderName) {
      if (!confirm(`Are you sure you want to delete "${folderName}"?`)) {
        return;
      }

      try {
        const token = localStorage.getItem("token");
        if (!token) {
          toastr.error("You must be logged in");
          window.location.href = "../login.html";
          return;
        }

        let url = `http://localhost:5025/api/Folder?folderId=${folderId}`;
        const response = await fetch(url, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
        });

        if (response.ok) {
          toastr.success(`Folder "${folderName}" deleted successfully!`);
          // Reload both folder list and dropdown
          await Promise.all([loadFoldersToDropdown()]);
        } else if (response.status === 401) {
          toastr.error("Session expired. Please login again.");
          setTimeout(() => {
            window.location.href = "../login.html";
          }, 2000);
        } else if (response.status === 404) {
          toastr.error("Folder not found");
        } else {
          const errorText = await response.text();
          toastr.error(errorText || "Failed to delete folder. Please try again.");
        }
      } catch (error) {
        console.error("Error deleting folder:", error);
        toastr.error("Network error. Please check your connection and try again.");
      }
    }
    function shareFolder(folderId, folderName) {
      if (!folderId) {
        toastr.error("Invalid folder ID");
        return;
      }
      // Redirect to share page with folder ID
      window.location.href = `share.html?id=${folderId}`;
    }

    async function logout() {
      if (!confirm("Are you sure you want to logout?")) {
        return;
      }

      try {
        const token = localStorage.getItem("token");
        if (!token) {
          toastr.warning("No active session found");
          window.location.href = "../login.html";
          return;
        }

        // Call logout API
        const response = await fetch("http://localhost:5025/api/Account/Logout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        if (response.ok) {
          // Remove token from localStorage
          localStorage.removeItem("token");
          toastr.success("Logged out successfully!");
          setTimeout(() => {
            window.location.href = "../login.html";
          }, 1000);
        } else if (response.status === 401) {
          // Token invalid or expired, still logout locally
          localStorage.removeItem("token");
          toastr.warning("Session expired. Redirecting to login...");
          setTimeout(() => {
            window.location.href = "../login.html";
          }, 1000);
        } else {
          const errorText = await response.text();
          toastr.error(errorText || "Logout failed. Please try again.");
        }
      } catch (error) {
        console.error("Error during logout:", error);
        // Even if API fails, logout locally
        localStorage.removeItem("token");
        toastr.warning("Network error. Logged out locally.");
        setTimeout(() => {
          window.location.href = "../login.html";
        }, 1500);
      }
    }

    function changePassword() {
      toastr.info("Change password feature - Coming soon!");
      // TODO: Implement change password modal or redirect to change password page
      // You can create a modal or redirect to a change password page
    }

    let folderBarChart = null;
    let folderPieChart = null;

    async function updateDashboardCounts() {
      try {
        const token = localStorage.getItem("token");
        if (!token) {
          return;
        }

        
        const myFoldersResponse = await fetch("http://localhost:5025/api/Folder", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        
        const sharedFoldersResponse = await fetch("http://localhost:5025/api/Folder/GetFolderByPermission", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        const myFolderCountElement = document.getElementById("myFolderCount");
        const sharedWithMeCountElement = document.getElementById("sharedWithMeCount");

        let myFolderCount = 0;
        let sharedCount = 0;

        if (myFoldersResponse.ok) {
          const myFolders = await myFoldersResponse.json();
          myFolderCount = myFolders ? myFolders.length : 0;
          myFolderCountElement.textContent = myFolderCount.toLocaleString();
        } else {
          myFolderCountElement.textContent = "0";
        }

        if (sharedFoldersResponse.ok) {
          const sharedFolders = await sharedFoldersResponse.json();
          sharedCount = sharedFolders ? sharedFolders.length : 0;
          sharedWithMeCountElement.textContent = sharedCount.toLocaleString();
        } else {
          sharedWithMeCountElement.textContent = "0";
        }

        
        updateCharts(myFolderCount, sharedCount);

      } catch (error) {
        console.error("Error updating dashboard counts:", error);
        const myFolderCountElement = document.getElementById("myFolderCount");
        const sharedWithMeCountElement = document.getElementById("sharedWithMeCount");
        
        if (myFolderCountElement) myFolderCountElement.textContent = "0";
        if (sharedWithMeCountElement) sharedWithMeCountElement.textContent = "0";
        
        updateCharts(0, 0);
      }
    }

    function updateCharts(myFolderCount, sharedCount) {
     
      if (folderBarChart) {
        folderBarChart.destroy();
      }
      if (folderPieChart) {
        folderPieChart.destroy();
      }

      
      const barCtx = document.getElementById('folderBarChart');
      if (barCtx) {
        folderBarChart = new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: ['My Folders', 'Shared With Me'],
            datasets: [{
              label: 'Number of Folders',
              data: [myFolderCount, sharedCount],
              backgroundColor: [
                'rgba(64, 78, 181, 0.8)',
                'rgba(255, 99, 132, 0.8)'
              ],
              borderColor: [
                'rgba(64, 78, 181, 1)',
                'rgba(255, 99, 132, 1)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                enabled: true
              }
            }
          }
        });
      }

      
      const pieCtx = document.getElementById('folderPieChart');
      if (pieCtx) {
        folderPieChart = new Chart(pieCtx, {
          type: 'pie',
          data: {
            labels: ['My Folders', 'Shared With Me'],
            datasets: [{
              label: 'Folder Distribution',
              data: [myFolderCount, sharedCount],
              backgroundColor: [
                'rgba(64, 78, 181, 0.8)',
                'rgba(255, 99, 132, 0.8)'
              ],
              borderColor: [
                'rgba(64, 78, 181, 1)',
                'rgba(255, 99, 132, 1)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'bottom'
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    let label = context.label || '';
                    if (label) {
                      label += ': ';
                    }
                    label += context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                    label += ' (' + percentage + '%)';
                    return label;
                  }
                }
              }
            }
          }
        });
      }
    }
  </script>
</body>

</html>