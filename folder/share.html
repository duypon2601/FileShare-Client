<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Share Folder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Stack+Sans+Notch:wght@200..700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
        integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <div class="main-container">
        <div class="row">
            <div class="col-lg-2">
                <div class="row sidebar">
                    <div class="col-lg-12 text-center">
                        <a style="text-decoration: none;" href="../index.html">
                            <h2 class="logo">FileShare</h2>
                        </a>
                    </div>
                    <div class="divider"></div>
                    <div class="col-lg-12 menu">
                        <div class="col-lg-8">
                            <a class="row menu-link" onclick="showMenu(1)"
                                style="box-shadow:2px 2px grey;border-radius:10px ;background-color:#e7f3ff;padding-left: 5%;">
                                <div class="col-lg-9"><span><i class="fa-solid fa-plus"></i></span> <span
                                        style="padding-left: 5%;">NEW</span></div>
                                <div id="menu-link-1" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
                            </a>

                        </div>
                        <div id="menu-content-1" style="display: none;" class="col-lg-10 menu-content">
                            <a class="menu-item col-lg-12"
                                onclick="window.location.href='../file/upload.html?id='+new URLSearchParams(window.location.search).get('id')">
                                <span><i class="fa-solid fa-minus "></i> <span style="padding-left: 5%;">Up Load File</span>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-12 menu">
                        <div class="col-lg-12">
                            <a class="row menu-link" onclick="showMenu(1)">
                                <div class="col-lg-9"><span><i class="fa-solid fa-house-laptop"></i></span> <span
                                        style="padding-left: 5%;">Home</span></div>
                                <div id="menu-link-1" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
                            </a>

                        </div>
                        <div id="menu-content-1" style="display: none;" class="col-lg-10 menu-content">
                            <a class="menu-item col-lg-12">
                                <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">Dashboard</span>
                            </a>
                        </div>
                    </div>

                    <div class="col-lg-12 menu">
                        <div class="col-lg-12">
                            <a class="row menu-link" onclick="showMenu(2)">
                                <div class="col-lg-9"><span><i class="fa-solid fa-house-laptop"></i></span> <span
                                        style="padding-left: 5%;">Folder</span></div>
                                <div id="menu-link-2" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
                            </a>

                        </div>
                        <div id="menu-content-2" style="display: none;" class="col-lg-10 menu-content">
                            <div class="row col-lg-12">
                                <a href="create.html" class="menu-item col-lg-12">
                                    <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">Add New Folder</span>
                                </a>
                                <a href="all.html" class="menu-item col-lg-12">
                                    <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">List All</span>
                                </a>
                                <a href="shareWithMe.html" class="menu-item col-lg-12">
                                    <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">Share With Me</span>
                                </a>
                                <div class="menu-item col-lg-12">
                                    <label>
                                        <select id="folderDropdown" class="form-select form-select-sm"
                                            onchange="navigateToFolder(this.value)">
                                            <option value="">Loading Folder...</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 menu">
                        <div class="col-lg-12">
                            <a class="row menu-link" onclick="showMenu(3)">
                                <div class="col-lg-9"><span><i class="fa-solid fa-folder-open"></i></span> <span
                                        style="padding-left: 5%;">My Folders</span></div>
                                <div id="menu-link-3" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
                            </a>

                        </div>
                        <div id="menu-content-3" style="display: none;" class="col-lg-10 menu-content">


                            <div id="folderDropdownList" class="col-lg-12">
                                <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                                    <i class="fa-solid fa-spinner fa-spin"></i> Loading...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 menu">
                        <div class="col-lg-12">
                            <a class="row menu-link" onclick="showMenu(4)">
                                <div class="col-lg-9"><span><i class="fa-solid fa-folder-open"></i></span> <span
                                        style="padding-left: 5%;">Share With Me</span></div>
                                <div id="menu-link-4" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
                            </a>

                        </div>
                        <div id="menu-content-4" style="display: none;" class="col-lg-10 menu-content">


                            <div id="sharedFolderDropdownList" class="col-lg-12">
                                <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                                    <i class="fa-solid fa-spinner fa-spin"></i> Loading...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 menu">
                        <div class="col-lg-12">
                            <a class="row menu-link" onclick="showMenu(5)">
                                <div class="col-lg-9"><span><i class="fa-solid fa-trash"></i></span> <span
                                        style="padding-left: 5%;">Trash Bin</span></div>
                                <div id="menu-link-5" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
                            </a>

                        </div>
                        <div id="menu-content-5" style="display: none;" class="col-lg-10 menu-content">
                            <div class="row col-lg-12">
                                <a href="trash.html" class="menu-item col-lg-12">
                                    <span><i class="fa-solid fa-trash-can"></i> <span style="padding-left: 5%;">View Trash</span>
                                </a>
                            </div>
                        </div>
                    </div>



                </div>
            </div>
            <div class="col-lg-10 main" style="
            margin-left: 0px;
            margin-right: 0px;
            padding-left: 0px;
            padding-right: 0px;
          ">
                <div class="main-navbar col-lg-12">
                    <div class="row align-items-center" style="width: 100%;">
                        <div class="col-lg-6">
                            <div class="row align-items-center">
                                <div class="col-lg-1"><i style="font-size: 20px;" class="fa-solid fa-bars"></i></div>
                                <div class="col-lg-7">
                                    <div class="input-group">
                                        <span class="input-group-text" id="basic-addon1" style="background-color:white;"><i class="fa-solid fa-magnifying-glass"></i></span>
                                        <input type="text" class="form-control" placeholder="Search" aria-label="Search" aria-describedby="basic-addon1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="d-flex justify-content-end align-items-center" style="padding-right: 20px;">
                                <div class="dropdown">
                                    <button class="btn btn-light dropdown-toggle" type="button" id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="border-radius: 50px; padding: 8px 20px; border: 1px solid #ddd;">
                                        <i class="fa-solid fa-user-circle" style="font-size: 20px; margin-right: 8px; color: #0d6efd;"></i>
                                        <span id="username-display" style="font-weight: 500;">User</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userMenuDropdown" style="min-width: 200px;">
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="changePassword(); return false;">
                                                <i class="fa-solid fa-key" style="margin-right: 8px;"></i> Change Password
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" onclick="logout(); return false;">
                                                <i class="fa-solid fa-right-from-bracket" style="margin-right: 8px;"></i> Logout
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row main-container"
                    style="padding:20px;border-radius:20px ;width: 98%;min-height: 600px;background-color: white;margin-top:100px;margin-left: 10px;margin-right: 10px;margin-bottom: 20px;">
                    <div class="col-lg-12 row">
                        <h2 id="folder-title" class="card-title text-center">Share Folder</h2>
                    </div>
                    <div class="col-lg-12 row">
                        <div class="col-lg-6 offset-lg-3">
                            <div class="card" style="box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none;">
                                <div class="card-body" style="padding: 30px;">
                                    <div class="text-center mb-4">
                                        <i class="fa-solid fa-share-nodes" style="font-size: 48px; color: #0d6efd;"></i>
                                        <h5 class="mt-3" id="folder-name-display">Loading folder...</h5>
                                        <p class="text-muted">Share this folder with another user</p>
                                    </div>

                                    <form id="share-form">
                                        <div class="mb-4">
                                            <label for="toEmail" class="form-label">
                                                <i class="fa-solid fa-envelope"></i> Recipient Email
                                            </label>
                                            <input 
                                                class="form-control" 
                                                type="email" 
                                                id="toEmail" 
                                                placeholder="Enter email address to share with"
                                                required 
                                            />
                                            <div class="form-text">
                                                Enter the email address of the person you want to share this folder with
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="alert alert-info">
                                                <i class="fa-solid fa-info-circle"></i>
                                                <strong>Note:</strong> The recipient will be able to view and download files in this folder.
                                            </div>
                                        </div>
                                        
                                        <button class="btn btn-primary col-lg-12" type="button" id="shareBtn"
                                            onclick="shareFolder()">
                                            <i class="fa-solid fa-share-nodes"></i> Share Folder
                                        </button>

                                        <a href="all.html" class="btn btn-secondary col-lg-12 mt-2">
                                            <i class="fa-solid fa-arrow-left"></i> Back to Folders
                                        </a>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"
        integrity="sha512-+k1pnlgt4F1H8L7t3z95o3/KO+o78INEcXTbnoJQ/F2VqDVhWoaiVml/OEHv9HsVgxUaVW+IbiZPUJQfF/YxZw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
        integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/js/all.min.js"
        integrity="sha512-6BTOlkauINO65nLhXhthZMtepgJSghyimIalb+crKRPhvhmsCdnIuGcVbR5/aQY2A+260iC1OPy1oCdB6pSSwQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        function showMenu(id) {
            let dropdown = document.getElementById("menu-link-" + id);
            let status = dropdown.dataset.status;
            if (status == 0) {
                document.getElementById("menu-link-" + id).innerHTML = '<i  class="fa-solid fa-angles-down"></i>';
                document.getElementById("menu-link-" + id).dataset.status = 1
                document.getElementById("menu-content-" + id).style.display = "flex";

            }
            else {
                document.getElementById("menu-link-" + id).innerHTML = '<i  class="fa-solid fa-angles-right"></i>'
                document.getElementById("menu-link-" + id).dataset.status = 0
                document.getElementById("menu-content-" + id).style.display = "none";
            }
        }

        // Get folderId from URL
        let folderId = null;
        let folderName = null;

        window.onload = async function () {
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "../login.html";
                return;
            }

            let checkedToken = await checkToken(token);
            if (!checkedToken) {
                window.location.href = "../login.html";
                return;
            }

            await loadFoldersToDropdown();
            await loadShareFoldersToDropdown();

            // Get folderId from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            folderId = urlParams.get('id');
            
            if (!folderId) {
                toastr.error("Folder ID is missing");
                setTimeout(() => {
                    window.location.href = "all.html";
                }, 2000);
                return;
            }

            // Load folder info
            await loadFolderInfo();
        };

        async function loadShareFoldersToDropdown() {
            try {
                const token = localStorage.getItem("token");
                const dropdownList = document.getElementById("sharedFolderDropdownList");
                if (!dropdownList) return;

                const response = await fetch("http://localhost:5025/api/Folder/GetFolderByPermission", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    }
                });

                if (response.ok) {
                    const folders = await response.json();

                    dropdownList.innerHTML = "";

                    if (folders && folders.length > 0) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const currentFolderId = urlParams.get('id');

                        folders.forEach(folder => {
                            const isActive = currentFolderId === folder.id;
                            const folderItem = document.createElement("a");
                            folderItem.href = `../file/allFleInFolder.html?id=${folder.id}`;
                            folderItem.className = "menu-item";
                            folderItem.style.cssText = isActive
                                ? "display: block; width: 100%; background-color: #e7f3ff; border-left: 3px solid #0d6efd; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;"
                                : "display: block; width: 100%; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;";

                            folderItem.innerHTML = `
                <i class="fa-solid fa-folder" style="color: ${isActive ? '#0d6efd' : '#666'}; font-size: 12px;"></i> 
                <span style="padding-left: 8px; font-size: 13px;">${folder.name || 'Unnamed Folder'}</span>
              `;

                            dropdownList.appendChild(folderItem);
                        });
                    } else {
                        dropdownList.innerHTML = `
              <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                <i class="fa-solid fa-folder-open"></i> No shared folders yet
              </div>
            `;
                    }
                } else {
                    dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Failed to load
            </div>
          `;
                    console.error("Failed to load shared folders:", response.status);
                }
            } catch (error) {
                console.error("Error loading shared folders to dropdown:", error);
                const dropdownList = document.getElementById("sharedFolderDropdownList");
                if (dropdownList) {
                    dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Error loading
            </div>
          `;
                }
            }
        }
        async function loadFoldersToDropdown() {
            try {
                const token = localStorage.getItem("token");
                const dropdownList = document.getElementById("folderDropdownList");

                if (!dropdownList) return;

                const response = await fetch("http://localhost:5025/api/Folder", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    }
                });

                if (response.ok) {
                    const folders = await response.json();

                    dropdownList.innerHTML = "";

                    if (folders && folders.length > 0) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const currentFolderId = urlParams.get('id');

                        folders.forEach(folder => {
                            const isActive = currentFolderId === folder.id;
                            const folderItem = document.createElement("a");
                            folderItem.href = `../file/allFleInFolder.html?id=${folder.id}`;
                            folderItem.className = "menu-item";
                            folderItem.style.cssText = isActive
                                ? "display: block; width: 100%; background-color: #e7f3ff; border-left: 3px solid #0d6efd; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;"
                                : "display: block; width: 100%; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;";

                            folderItem.innerHTML = `
                <i class="fa-solid fa-folder" style="color: ${isActive ? '#0d6efd' : '#666'}; font-size: 12px;"></i> 
                <span style="padding-left: 8px; font-size: 13px;">${folder.name || 'Unnamed Folder'}</span>
              `;

                            dropdownList.appendChild(folderItem);
                        });
                    } else {
                        dropdownList.innerHTML = `
              <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                <i class="fa-solid fa-folder-open"></i> No folders yet
              </div>
            `;
                    }
                } else {
                    dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Failed to load
            </div>
          `;
                    console.error("Failed to load folders:", response.status);
                }
            } catch (error) {
                console.error("Error loading folders to dropdown:", error);
                const dropdownList = document.getElementById("folderDropdownList");
                if (dropdownList) {
                    dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Error loading
            </div>
          `;
                }
            }
        }


        async function loadFolderInfo() {
            try {
                const token = localStorage.getItem("token");
                const response = await fetch("http://localhost:5025/api/Folder", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    }
                });

                if (response.ok) {
                    const folders = await response.json();
                    const folder = folders.find(f => f.id === folderId);
                    
                    if (folder) {
                        folderName = folder.name;
                        document.getElementById("folder-name-display").textContent = folder.name;
                    } else {
                        toastr.error("Folder not found");
                        setTimeout(() => {
                            window.location.href = "all.html";
                        }, 2000);
                    }
                } else {
                    toastr.error("Failed to load folder information");
                }
            } catch (error) {
                console.error("Error loading folder info:", error);
                toastr.error("Failed to load folder information");
            }
        }

        async function shareFolder() {
            const toEmail = document.getElementById("toEmail").value.trim();
            
            if (!toEmail) {
                toastr.warning("Please enter an email address");
                return;
            }

            if (!folderId) {
                toastr.error("Folder ID is missing");
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(toEmail)) {
                toastr.warning("Please enter a valid email address");
                return;
            }

            const shareBtn = document.getElementById("shareBtn");
            const originalText = shareBtn.innerHTML;
            shareBtn.disabled = true;
            shareBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sharing...';

            try {
                const token = localStorage.getItem("token");
                if (!token) {
                    toastr.error("You must be logged in");
                    window.location.href = "../login.html";
                    return;
                }

                const response = await fetch("http://localhost:5025/api/Folder/ShareFolder", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    },
                    body: JSON.stringify({
                        folderId: folderId,
                        toEmail: toEmail
                    })
                });

                if (response.ok) {
                    const message = await response.text();
                    toastr.success(message || `Folder "${folderName}" shared successfully with ${toEmail}!`);
                    
                    // Clear form
                    document.getElementById("toEmail").value = "";
                    
                    // Redirect after a delay
                    setTimeout(() => {
                        window.location.href = "all.html";
                    }, 2000);
                } else if (response.status === 401) {
                    toastr.error("Session expired. Please login again.");
                    setTimeout(() => {
                        window.location.href = "../login.html";
                    }, 2000);
                } else {
                    const errorText = await response.text();
                    toastr.error(errorText || "Failed to share folder. Please try again.");
                }
            } catch (error) {
                console.error("Error sharing folder:", error);
                toastr.error("Network error. Please check your connection and try again.");
            } finally {
                shareBtn.disabled = false;
                shareBtn.innerHTML = originalText;
            }
        }

        async function checkToken(token) {
            let url = "http://localhost:5025/api/Account/CheckToken";
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token,
                },
                body: null,
            });
            if (response.ok) {
                return true;
            } else {
                return false;
            }
        }

        async function logout() {
            if (!confirm("Are you sure you want to logout?")) {
                return;
            }

            try {
                const token = localStorage.getItem("token");
                if (!token) {
                    toastr.warning("No active session found");
                    window.location.href = "../login.html";
                    return;
                }

                const response = await fetch("http://localhost:5025/api/Account/Logout", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    }
                });

                if (response.ok) {
                    localStorage.removeItem("token");
                    toastr.success("Logged out successfully!");
                    setTimeout(() => {
                        window.location.href = "../login.html";
                    }, 1000);
                } else if (response.status === 401) {
                    localStorage.removeItem("token");
                    toastr.warning("Session expired. Redirecting to login...");
                    setTimeout(() => {
                        window.location.href = "../login.html";
                    }, 1000);
                } else {
                    const errorText = await response.text();
                    toastr.error(errorText || "Logout failed. Please try again.");
                }
            } catch (error) {
                console.error("Error during logout:", error);
                localStorage.removeItem("token");
                toastr.warning("Network error. Logged out locally.");
                setTimeout(() => {
                    window.location.href = "../login.html";
                }, 1500);
            }
        }

        function changePassword() {
            toastr.info("Change password feature - Coming soon!");
        }
    </script>
</body>

</html>