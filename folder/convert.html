<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Stack+Sans+Notch:wght@200..700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script>
    // Define toggle functions early for inline event handlers
    function toggleSourceMode() {
      const sourceMode = document.querySelector('input[name="sourceMode"]:checked')?.value;
      const existingSection = document.getElementById('existingFileSection');
      const uploadSection = document.getElementById('uploadFileSection');
      
      if (!existingSection || !uploadSection) {
        console.error('Sections not found!');
        return;
      }
      
      if (sourceMode === 'upload') {
        existingSection.style.display = 'none';
        uploadSection.style.display = 'block';
        if (typeof toggleDestinationFolder === 'function') {
          toggleDestinationFolder();
        }
      } else {
        existingSection.style.display = 'block';
        uploadSection.style.display = 'none';
      }
    }

    function toggleDestinationFolder() {
      const outputAction = document.querySelector('input[name="outputAction"]:checked')?.value;
      const uploadDestinationFolder = document.getElementById('uploadDestinationFolder');
      
      if (!uploadDestinationFolder) {
        return;
      }
      
      // Show folder selection whenever save action is selected
      if (outputAction === 'save') {
        uploadDestinationFolder.style.display = 'block';
      } else {
        uploadDestinationFolder.style.display = 'none';
      }
    }
  </script>
</head>

<body>
  <div class="main-container">
    <div class="row">
      <div class="col-lg-2">
        <div class="row sidebar">
          <div class="col-lg-12 text-center">
            <a style="text-decoration: none;" href="../index.html">
              <h2 class="logo">FileShare</h2>
            </a>
          </div>
          <div class="divider"></div>
          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(1)"
                style="box-shadow:2px 2px grey;border-radius:10px ;background-color:#e7f3ff;padding-left: 5%; width: 100%;">
                <div class="col-lg-9"><span><i class="fa-solid fa-plus"></i></span> <span
                    style="padding-left: 5%;">NEW</span></div>
                <div id="menu-link-1" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-1" style="display: none;" class="col-lg-10 menu-content">
              <a class="menu-item col-lg-12"
                onclick="window.location.href='../file/upload.html?id='+new URLSearchParams(window.location.search).get('id')">
                <span><i class="fa-solid fa-minus "></i> <span style="padding-left: 5%;">Up Load File</span>
              </a>
            </div>
            <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" href="convert.html"
                style="box-shadow:2px 2px grey;border-radius:10px ;background-color:#e7f3ff;padding-left: 5%; width: 100%;">
                <div class="col-lg-9"><span><i class="fa-solid fa-file-export"></i></span> <span
                    style="padding-left: 5%;">Convert Files</span></div>
              </a>
            </div>
          </div>
          </div>
          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(6)">
                <div class="col-lg-9"><span><i class="fa-solid fa-house-laptop"></i></span> <span
                    style="padding-left: 5%;">Home</span></div>
                <div id="menu-link-6" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-6" style="display: none;" class="col-lg-10 menu-content" >
              <a class="menu-item col-lg-12" href="../index.html">
                <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">Dashboard</span>
              </a>
            </div>
          </div>

          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(2)">
                <div class="col-lg-9"><span><i class="fa-solid fa-house-laptop"></i></span> <span
                    style="padding-left: 5%;">Folder</span></div>
                <div id="menu-link-2" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-2" style="display: none;" class="col-lg-10 menu-content">
              <div class="row col-lg-12">
                <a href="create.html" class="menu-item col-lg-12">
                  <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">Add New Folder</span>
                </a>
                <a href="all.html" class="menu-item col-lg-12">
                  <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">List All</span>
                </a>
                <a href="shareWithMe.html" class="menu-item col-lg-12">
                  <span><i class="fa-solid fa-minus"></i> <span style="padding-left: 5%;">Share With Me</span>
                </a>
                <div class="menu-item col-lg-12">
                  <label>
                    <select id="folderDropdown" class="form-select form-select-sm"
                      onchange="navigateToFolder(this.value)">
                      <option value="">Loading Folder...</option>
                    </select>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(3)">
                <div class="col-lg-9"><span><i class="fa-solid fa-folder-open"></i></span> <span
                    style="padding-left: 5%;">My Folders</span></div>
                <div id="menu-link-3" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-3" style="display: none;" class="col-lg-10 menu-content">


              <div id="folderDropdownList" class="col-lg-12">
                <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                  <i class="fa-solid fa-spinner fa-spin"></i> Loading...
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(4)">
                <div class="col-lg-9"><span><i class="fa-solid fa-folder-open"></i></span> <span
                    style="padding-left: 5%;">Share With Me</span></div>
                <div id="menu-link-4" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-4" style="display: none;" class="col-lg-10 menu-content">


              <div id="sharedFolderDropdownList" class="col-lg-12">
                <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                  <i class="fa-solid fa-spinner fa-spin"></i> Loading...
                </div>
              </div>
            </div>
          </div>

          

          <div class="col-lg-12 menu">
            <div class="col-lg-12">
              <a class="row menu-link" onclick="showMenu(5)">
                <div class="col-lg-9"><span><i class="fa-solid fa-trash"></i></span> <span
                    style="padding-left: 5%;">Trash Bin</span></div>
                <div id="menu-link-5" data-status="0" class="col-lg-2"><i class="fa-solid fa-angles-right"></i> </div>
              </a>

            </div>
            <div id="menu-content-5" style="display: none;" class="col-lg-10 menu-content">
              <div class="row col-lg-12">
                <a href="trash.html" class="menu-item col-lg-12">
                  <span><i class="fa-solid fa-trash-can"></i> <span style="padding-left: 5%;">View Trash</span>
                </a>
              </div>
            </div>
          </div>



        </div>
      </div>
      <div class="col-lg-10 main" style="
            margin-left: 0px;
            margin-right: 0px;
            padding-left: 0px;
            padding-right: 0px;
          ">
        <div class="main-navbar col-lg-12">
          <div class="row align-items-center" style="width: 100%;">
            <div class="col-lg-6">
              <div class="row align-items-center">
                <div class="col-lg-1"><i style="font-size: 20px;" class="fa-solid fa-bars"></i></div>
                <div class="col-lg-7">
                  <div class="input-group">
                    <span class="input-group-text" id="basic-addon1" style="background-color:white;"><i
                        class="fa-solid fa-magnifying-glass"></i></span>
                    <input type="text" class="form-control" placeholder="Search" aria-label="Search"
                      aria-describedby="basic-addon1">
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="d-flex justify-content-end align-items-center" style="padding-right: 20px;">
                <div class="dropdown">
                  <button class="btn btn-light dropdown-toggle" type="button" id="userMenuDropdown"
                    data-bs-toggle="dropdown" aria-expanded="false"
                    style="border-radius: 50px; padding: 8px 20px; border: 1px solid #ddd;">
                    <i class="fa-solid fa-user-circle" style="font-size: 20px; margin-right: 8px; color: #0d6efd;"></i>
                    <span id="username-display" style="font-weight: 500;">User</span>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userMenuDropdown"
                    style="min-width: 200px;">
                    <li>
                      <a class="dropdown-item" href="#" onclick="changePassword(); return false;">
                        <i class="fa-solid fa-key" style="margin-right: 8px;"></i> Change Password
                      </a>
                    </li>
                    <li>
                      <hr class="dropdown-divider">
                    </li>
                    <li>
                      <a class="dropdown-item text-danger" href="#" onclick="logout(); return false;">
                        <i class="fa-solid fa-right-from-bracket" style="margin-right: 8px;"></i> Logout
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row main-container"
          style="padding:20px;border-radius:20px ;width: 98%;min-height: 600px;background-color: white;margin-top:100px;margin-left: 10px;margin-right: 10px;margin-bottom: 20px;">
          <div class="col-lg-12 row">
            <h2 class="content-title"><i class="fa-solid fa-file-export"></i> Convert Files</h2>
            <p class="text-muted">Convert your files to different formats</p>
          </div>
          
          <div class="col-lg-12" style="margin-top:30px;">
            <div class="card shadow-sm">
              <div class="card-body" style="padding: 30px;">
                <form id="convertForm">
                  
                  <!-- Source Mode Selection -->
                  <div class="mb-4">
                    <label class="form-label fw-bold">
                      <i class="fa-solid fa-file-import"></i> File Source
                    </label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="sourceMode" id="sourceModeExisting" value="existing" checked onchange="toggleSourceMode()">
                        <label class="form-check-label" for="sourceModeExisting">
                          <i class="fa-solid fa-folder-open"></i> From Existing Files
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="sourceMode" id="sourceModeUpload" value="upload" onchange="toggleSourceMode()">
                        <label class="form-check-label" for="sourceModeUpload">
                          <i class="fa-solid fa-upload"></i> Upload New File
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Existing File Selection Section -->
                  <div id="existingFileSection">
                    <!-- Folder Selection -->
                    <div class="mb-4">
                      <label for="folderSelect" class="form-label fw-bold">
                        <i class="fa-solid fa-folder"></i> Select Folder
                      </label>
                      <select class="form-select" id="folderSelect">
                        <option value="">Loading folders...</option>
                      </select>
                      <div class="form-text">Choose the folder containing your file</div>
                    </div>

                    <!-- File Selection -->
                    <div class="mb-4">
                      <label for="fileSelect" class="form-label fw-bold">
                        <i class="fa-solid fa-file"></i> Select File
                      </label>
                      <select class="form-select" id="fileSelect" disabled>
                        <option value="">Please select a folder first</option>
                      </select>
                      <div class="form-text">Choose the file you want to convert</div>
                    </div>
                  </div>

                  <!-- Upload File Section -->
                  <div id="uploadFileSection" style="display: none;">
                    <div class="mb-4">
                      <label for="uploadFile" class="form-label fw-bold">
                        <i class="fa-solid fa-file-arrow-up"></i> Upload File
                      </label>
                      <input type="file" class="form-control" id="uploadFile" accept="*/*">
                      <div class="form-text">Select a file from your computer to convert</div>
                    </div>
                  </div>

                  <!-- Source Type -->
                  <div class="mb-4">
                    <label for="sourceType" class="form-label fw-bold">
                      <i class="fa-solid fa-file-circle-question"></i> Source File Type
                    </label>
                    <select class="form-select" id="sourceType" required>
                      <option value="">Select source type...</option>
                      <option value="pdf">PDF</option>
                      <option value="docx">Word Document (DOCX)</option>
                      <option value="xlsx">Excel Spreadsheet (XLSX)</option>
                      <option value="pptx">PowerPoint (PPTX)</option>
                      <option value="txt">Text File (TXT)</option>
                      <option value="jpg">Image (JPG)</option>
                      <option value="png">Image (PNG)</option>
                      <option value="csv">CSV</option>
                    </select>
                    <div class="form-text">Original format of your file</div>
                  </div>

                  <!-- Output Action/Format -->
                  <div class="mb-4">
                    <label for="outputFormat" class="form-label fw-bold">
                      <i class="fa-solid fa-arrow-right-arrow-left"></i> Convert To
                    </label>
                    <select class="form-select" id="outputFormat" required>
                      <option value="">Select output format...</option>
                      <option value="pdf">PDF</option>
                      <option value="docx">Word Document (DOCX)</option>
                      <option value="xlsx">Excel Spreadsheet (XLSX)</option>
                      <option value="pptx">PowerPoint (PPTX)</option>
                      <option value="txt">Text File (TXT)</option>
                      <option value="jpg">Image (JPG)</option>
                      <option value="png">Image (PNG)</option>
                      <option value="ico">Icon (ICO)</option>
                      <option value="csv">CSV</option>
                      <option value="html">HTML</option>
                    </select>
                    <div class="form-text">Target format for conversion</div>
                  </div>

                  <!-- Output Action Selection -->
                  <div class="mb-4">
                    <label class="form-label fw-bold">
                      <i class="fa-solid fa-download"></i> After Conversion
                    </label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="outputAction" id="outputActionSave" value="save" checked>
                        <label class="form-check-label" for="outputActionSave">
                          <i class="fa-solid fa-floppy-disk"></i> Save to Folder
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="outputAction" id="outputActionDownload" value="download">
                        <label class="form-check-label" for="outputActionDownload">
                          <i class="fa-solid fa-download"></i> Download File
                        </label>
                      </div>
                    </div>
                    <div class="form-text">Choose whether to save the converted file to your folder or download it immediately</div>
                  </div>

                  <!-- Destination Folder (for save action - shown when Save to Folder is selected) -->
                  <div class="mb-4" id="uploadDestinationFolder" style="display: block;">
                    <label for="uploadFolderSelect" class="form-label fw-bold">
                      <i class="fa-solid fa-folder-plus"></i> Destination Folder
                    </label>
                    <select class="form-select" id="uploadFolderSelect">
                      <option value="">Select destination folder...</option>
                    </select>
                    <div class="form-text">Choose the folder to save the converted file</div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="d-flex gap-3 mt-4">
                    <button type="submit" class="btn btn-primary btn-lg flex-fill" id="convertBtn">
                      <i class="fa-solid fa-sync"></i> Convert File
                    </button>
                    <button type="reset" class="btn btn-outline-secondary btn-lg" onclick="resetForm()">
                      <i class="fa-solid fa-rotate-left"></i> Reset
                    </button>
                  </div>
                </form>

                <!-- Progress indicator -->
                <div id="convertProgress" class="mt-4" style="display: none;">
                  <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                      <div class="spinner-border spinner-border-sm me-3" role="status">
                        <span class="visually-hidden">Converting...</span>
                      </div>
                      <div>
                        <strong>Converting your file...</strong>
                        <p class="mb-0 small">Please wait, this may take a few moments.</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Result area -->
                <div id="convertResult" class="mt-4" style="display: none;">
                  <!-- Result will be shown here -->
                </div>

              </div>
            </div>
          </div>

          <!-- Conversion History/Info -->
          <div class="col-lg-12 mt-4">
            <div class="card shadow-sm">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fa-solid fa-circle-info"></i> Supported Conversions</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="fw-bold">Document Conversions:</h6>
                    <ul class="list-unstyled small">
                      <li><i class="fa-solid fa-check text-success"></i> PDF ↔ DOCX, TXT, HTML</li>
                      <li><i class="fa-solid fa-check text-success"></i> DOCX ↔ PDF, TXT, HTML</li>
                      <li><i class="fa-solid fa-check text-success"></i> TXT ↔ PDF, DOCX</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="fw-bold">Image Conversions:</h6>
                    <ul class="list-unstyled small">
                      <li><i class="fa-solid fa-check text-success"></i> JPG ↔ PNG, PDF</li>
                      <li><i class="fa-solid fa-check text-success"></i> PNG ↔ JPG, PDF, ICO</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="fw-bold">Spreadsheet Conversions:</h6>
                    <ul class="list-unstyled small">
                      <li><i class="fa-solid fa-check text-success"></i> XLSX ↔ CSV, PDF</li>
                      <li><i class="fa-solid fa-check text-success"></i> CSV ↔ XLSX</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="fw-bold">Presentation Conversions:</h6>
                    <ul class="list-unstyled small">
                      <li><i class="fa-solid fa-check text-success"></i> PPTX ↔ PDF</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>


      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"
    integrity="sha512-+k1pnlgt4F1H8L7t3z95o3/KO+o78INEcXTbnoJQ/F2VqDVhWoaiVml/OEHv9HsVgxUaVW+IbiZPUJQfF/YxZw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
    integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/js/all.min.js"
    integrity="sha512-6BTOlkauINO65nLhXhthZMtepgJSghyimIalb+crKRPhvhmsCdnIuGcVbR5/aQY2A+260iC1OPy1oCdB6pSSwQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    function showMenu(id) {
      let dropdown = document.getElementById("menu-link-" + id);
      let status = dropdown.dataset.status;
      if (status == 0) {
        document.getElementById("menu-link-" + id).innerHTML = '<i  class="fa-solid fa-angles-down"></i>';
        document.getElementById("menu-link-" + id).dataset.status = 1
        document.getElementById("menu-content-" + id).style.display = "flex";

      }
      else {
        document.getElementById("menu-link-" + id).innerHTML = '<i  class="fa-solid fa-angles-right"></i>'
        document.getElementById("menu-link-" + id).dataset.status = 0
        document.getElementById("menu-content-" + id).style.display = "none";
      }
    }

    window.onload = async function () {
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "../login.html";
        return;
      }

      let checkedToken = await checkToken(token);
      if (!checkedToken) {
        window.location.href = "../login.html";
        return;
      }
      await loadFoldersToDropdown();
      await loadShareFoldersToDropdown();
      await loadFoldersForConvert();
    };

    async function loadFoldersForConvert() {
      try {
        const token = localStorage.getItem("token");
        const folderSelect = document.getElementById("folderSelect");
        const uploadFolderSelect = document.getElementById("uploadFolderSelect");

        const response = await fetch("http://localhost:5025/api/Folder", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        if (response.ok) {
          const folders = await response.json();
          
          // Load into existing file folder select
          if (folderSelect) {
            folderSelect.innerHTML = '<option value="">Select a folder...</option>';
            
            if (folders && folders.length > 0) {
              folders.forEach(folder => {
                const option = document.createElement("option");
                option.value = folder.id;
                option.textContent = folder.name || 'Unnamed Folder';
                option.dataset.folderName = folder.name;
                folderSelect.appendChild(option);
              });
            } else {
              folderSelect.innerHTML = '<option value="">No folders available</option>';
            }
          }

          // Load into upload destination folder select
          if (uploadFolderSelect) {
            uploadFolderSelect.innerHTML = '<option value="">Select a folder...</option>';
            
            if (folders && folders.length > 0) {
              folders.forEach(folder => {
                const option = document.createElement("option");
                option.value = folder.id;
                option.textContent = folder.name || 'Unnamed Folder';
                option.dataset.folderName = folder.name;
                uploadFolderSelect.appendChild(option);
              });
            } else {
              uploadFolderSelect.innerHTML = '<option value="">No folders available</option>';
            }
          }
        } else {
          toastr.error("Failed to load folders");
          if (folderSelect) folderSelect.innerHTML = '<option value="">Error loading folders</option>';
          if (uploadFolderSelect) uploadFolderSelect.innerHTML = '<option value="">Error loading folders</option>';
        }
      } catch (error) {
        console.error("Error loading folders:", error);
        toastr.error("Error loading folders");
      }
    }

    // Load files when folder is selected
    document.addEventListener('DOMContentLoaded', function() {
      const folderSelect = document.getElementById("folderSelect");
      const fileSelect = document.getElementById("fileSelect");
      
      // Toggle destination folder visibility when output action changes
      const outputActionRadios = document.querySelectorAll('input[name="outputAction"]');
      outputActionRadios.forEach(radio => {
        radio.addEventListener('change', toggleDestinationFolder);
      });
      
      if (folderSelect) {
        folderSelect.addEventListener('change', async function() {
          const folderId = this.value;
          
          if (!folderId) {
            fileSelect.disabled = true;
            fileSelect.innerHTML = '<option value="">Please select a folder first</option>';
            return;
          }
          
          // Load files for selected folder
          await loadFilesForFolder(folderId);
        });
      }

      // Handle form submission
      const convertForm = document.getElementById("convertForm");
      if (convertForm) {
        convertForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          await handleConvert();
        });
      }
    });
    async function getFilePath(fileName, folderId) {
      try {
        const token = localStorage.getItem("token");

        const response = await fetch(`http://localhost:5025/api/File/GetFilePathByNameAndFolder?fileName=${encodeURIComponent(fileName)}&folderId=${folderId}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        if (response.ok) {
          let filePath = await response.text();
          // Remove leading slash/backslash to ensure proper Path.Combine in backend
          filePath = filePath.replace(/^[\\\/]+/, '');
          return filePath || '';
        } else {
          toastr.error("Failed to get file path");
          return '';
        }
      } catch (error) {
        console.error("Error getting file path:", error);
        toastr.error("Error getting file path");
        return '';
      }
      
    }

    async function loadFilesForFolder(folderId) {
      try {
        const token = localStorage.getItem("token");
        const fileSelect = document.getElementById("fileSelect");
        
        if (!fileSelect) return;

        fileSelect.disabled = true;
        fileSelect.innerHTML = '<option value="">Loading files...</option>';

        const response = await fetch(`http://localhost:5025/api/File/GetByFolder?folderId=${folderId}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        if (response.ok) {
          const files = await response.json();
          
          fileSelect.innerHTML = '<option value="">Select a file...</option>';
          
          if (files && files.length > 0) {
            files.forEach(file => {
              const option = document.createElement("option");
              option.value = file.id;
              option.textContent = file.name || 'Unnamed File';
              option.dataset.fileName = file.name;
              option.dataset.fileId = file.id; // Lưu fileId vào data attribute
              fileSelect.appendChild(option);
            });
            fileSelect.disabled = false;
          } else {
            fileSelect.innerHTML = '<option value="">No files in this folder</option>';
          }
        } else {
          toastr.error("Failed to load files");
          fileSelect.innerHTML = '<option value="">Error loading files</option>';
        }
      } catch (error) {
        console.error("Error loading files:", error);
        const fileSelect = document.getElementById("fileSelect");
        if (fileSelect) {
          fileSelect.innerHTML = '<option value="">Error loading files</option>';
        }
        toastr.error("Error loading files");
      }
    }

    async function handleConvert() {
      const sourceMode = document.querySelector('input[name="sourceMode"]:checked').value;
      const folderSelect = document.getElementById("folderSelect");
      const fileSelect = document.getElementById("fileSelect");
      const uploadFile = document.getElementById("uploadFile");
      const sourceType = document.getElementById("sourceType").value;
      const outputFormat = document.getElementById("outputFormat").value;
      const outputAction = document.querySelector('input[name="outputAction"]:checked').value;
      const convertBtn = document.getElementById("convertBtn");
      const convertProgress = document.getElementById("convertProgress");
      const convertResult = document.getElementById("convertResult");

      // Validation
      if (sourceMode === 'existing') {
        if (!folderSelect.value || !fileSelect.value) {
          toastr.error("Please select folder and file");
          return;
        }
      } else if (sourceMode === 'upload') {
        if (!uploadFile.files || uploadFile.files.length === 0) {
          toastr.error("Please select a file to upload");
          return;
        }
      }

      // Validate destination folder for save action
      if (outputAction === 'save') {
        const uploadFolderSelect = document.getElementById("uploadFolderSelect");
        if (!uploadFolderSelect || !uploadFolderSelect.value) {
          toastr.error("Please select a destination folder");
          return;
        }
      }

      if (!sourceType || !outputFormat) {
        toastr.error("Please select source type and output format");
        return;
      }

      if (sourceType === outputFormat) {
        toastr.warning("Source and output formats are the same!");
        return;
      }

      try {
        const token = localStorage.getItem("token");
        let folderName = '';
        let fileName = '';

        if (sourceMode === 'existing') {
          folderName = folderSelect.options[folderSelect.selectedIndex].dataset.folderName;
          fileName = fileSelect.options[fileSelect.selectedIndex].dataset.fileName;
        }

        // Show progress
        convertProgress.style.display = 'block';
        convertResult.style.display = 'none';
        convertBtn.disabled = true;

        // Check if this is PNG to ICO conversion
        if (sourceType.toLowerCase() === 'png' && outputFormat.toLowerCase() === 'ico') {
          const fileId = sourceMode === 'existing' ? fileSelect.value : null;
          const folderId = sourceMode === 'existing' ? folderSelect.value : null;
          await handlePngToIcoConversion(token, sourceMode, folderName, fileName, uploadFile.files[0], outputAction, folderId, fileId);
          return; 
        }

        let response;
        
        if (sourceMode === 'upload') {
          // Handle upload mode
          const formData = new FormData();
          formData.append('SourceType', 'upload');
          formData.append('OutputAction', outputAction);
          formData.append('uploadFIle', uploadFile.files[0]);
          
          // Add DestinationFolderId for save action
          if (outputAction === 'save') {
            const uploadFolderSelect = document.getElementById('uploadFolderSelect');
            
            if (!uploadFolderSelect.value) {
              convertProgress.style.display = 'none';
              convertBtn.disabled = false;
              toastr.error("Please select a folder to save the converted file");
              return;
            }
            
            formData.append('DestinationFolderId', uploadFolderSelect.value);
          }

          response = await fetch("http://localhost:5025/api/Convert/ConvertToPdf", {
            method: "POST",
            headers: { Authorization: "Bearer " + token },
            body: formData
          });
        } else {
          // Handle existing file mode
          const uploadFolderSelect = document.getElementById("uploadFolderSelect");
          let destinationFolderId = null;
          
          if (outputAction === 'save') {
            if (uploadFolderSelect && uploadFolderSelect.value) {
              destinationFolderId = uploadFolderSelect.value;
            }
          }
          
          const requestBody = {
            FolderName: folderName,
            FileName: fileName,
            SourceType: sourceType,
            OutputFormat: outputFormat,
            OutputAction: outputAction,
            DestinationFolderId: destinationFolderId
          };

          response = await fetch("http://localhost:5025/api/Convert", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify(requestBody)
          });
        }

        // Hide progress
        convertProgress.style.display = 'none';
        convertBtn.disabled = false;

        if (response.ok) {
          // Handle download action
          if (outputAction === 'download') {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            let downloadFileName = '';
            if (sourceMode === 'upload') {
              const originalName = uploadFile.files[0].name;
              downloadFileName = originalName.substring(0, originalName.lastIndexOf('.')) + '_Converted.' + outputFormat;
            } else {
              downloadFileName = fileName.substring(0, fileName.lastIndexOf('.')) + '_Converted.' + outputFormat;
            }
            
            a.download = downloadFileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            convertResult.innerHTML = `
              <div class="alert alert-success">
                <h5 class="alert-heading">
                  <i class="fa-solid fa-check-circle"></i> Conversion & Download Successful!
                </h5>
                <hr>
                <p class="mb-0">
                  <strong>File:</strong> ${downloadFileName}<br>
                  <strong>Converted from:</strong> ${sourceType.toUpperCase()}<br>
                  <strong>Converted to:</strong> ${outputFormat.toUpperCase()}<br>
                  <strong>Status:</strong> <span class="badge bg-success">Downloaded</span>
                </p>
              </div>
            `;
            convertResult.style.display = 'block';
            toastr.success("File converted and downloaded successfully!");
          } else {
            // Handle save action
            const result = await response.json();
            const targetFolderId = sourceMode === 'upload' ? document.getElementById('uploadFolderSelect').value : folderSelect.value;
            
            convertResult.innerHTML = `
              <div class="alert alert-success">
                <h5 class="alert-heading">
                  <i class="fa-solid fa-check-circle"></i> Conversion Successful!
                </h5>
                <hr>
                <p class="mb-0">
                  <strong>File:</strong> ${fileName || uploadFile.files[0].name}<br>
                  <strong>Converted from:</strong> ${sourceType.toUpperCase()}<br>
                  <strong>Converted to:</strong> ${outputFormat.toUpperCase()}<br>
                  <strong>Status:</strong> <span class="badge bg-success">Saved to Folder</span>
                </p>
                <div class="mt-3">
                  <button class="btn btn-success" onclick="window.location.href='../file/allFleInFolder.html?id=${targetFolderId}'">
                    <i class="fa-solid fa-folder-open"></i> View Files
                  </button>
                </div>
              </div>
            `;
            convertResult.style.display = 'block';
            toastr.success("File converted successfully!");
          }
          
          // Reset form after a delay
          setTimeout(() => {
            resetForm();
          }, 3000);
          
        } else {
          const errorText = await response.text();
          
          // Show error result
          convertResult.innerHTML = `
            <div class="alert alert-danger">
              <h5 class="alert-heading">
                <i class="fa-solid fa-exclamation-triangle"></i> Conversion Failed
              </h5>
              <p class="mb-0">${errorText || "An error occurred during conversion. Please try again."}</p>
            </div>
          `;
          convertResult.style.display = 'block';
          
          toastr.error(errorText || "Conversion failed");
        }
      } catch (error) {
        console.error("Error during conversion:", error);
        
        convertProgress.style.display = 'none';
        convertBtn.disabled = false;
        
        convertResult.innerHTML = `
          <div class="alert alert-danger">
            <h5 class="alert-heading">
              <i class="fa-solid fa-exclamation-triangle"></i> Network Error
            </h5>
            <p class="mb-0">Failed to connect to the server. Please check your connection and try again.</p>
          </div>
        `;
        convertResult.style.display = 'block';
        
        toastr.error("Network error during conversion");
      }
    }

    function resetForm() {
      document.getElementById("convertForm").reset();
      document.getElementById("fileSelect").disabled = true;
      document.getElementById("fileSelect").innerHTML = '<option value="">Please select a folder first</option>';
      document.getElementById("uploadFile").value = '';
      document.getElementById("convertResult").style.display = 'none';
      document.getElementById("convertProgress").style.display = 'none';
      
      // Reset to default source mode (existing)
      document.getElementById("sourceModeExisting").checked = true;
      toggleSourceMode();
      
      // Reset output action to save
      document.getElementById("outputActionSave").checked = true;
      toggleDestinationFolder();
    }

    // Decode JWT token to get AccId
    function getAccIdFromToken(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        
        const payload = JSON.parse(jsonPayload);
        return payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier'] || payload.nameidentifier || payload.sub || '';
      } catch (error) {
        console.error('Error decoding token:', error);
        return '';
      }
    }

    async function handlePngToIcoConversion(token, sourceMode, folderName, fileName, uploadedFile, outputAction, folderId, fileId) {
      const convertProgress = document.getElementById("convertProgress");
      const convertResult = document.getElementById("convertResult");
      const convertBtn = document.getElementById("convertBtn");

      try {
        // Prepare form data for PNG to ICO conversion
        const formData = new FormData();
        
        if (sourceMode === 'upload') {
          formData.append('SourceType', 'upload');
          formData.append('OutputAction', outputAction);
          formData.append('uploadFile', uploadedFile);
        } else {
          // For existing files, get the file path and send it
          const filePath = await getFilePath(fileName, folderId);
          if (!filePath) {
            convertProgress.style.display = 'none';
            convertBtn.disabled = false;
            toastr.error("Could not get file path");
            return;
          }
          formData.append('SourceType', 'existing');
          formData.append('OutputAction', outputAction);
          formData.append('FilePath', filePath);
          formData.append('FileName', fileName);
        }
        
        // Add DestinationFolderId if save action
        if (outputAction === 'save') {
          const uploadFolderSelect = document.getElementById("uploadFolderSelect");
          if (uploadFolderSelect && uploadFolderSelect.value) {
            formData.append('DestinationFolderId', uploadFolderSelect.value);
          }
        }

        console.log('Sending request to ConvertPngToIcoV2 with:');
        for (let pair of formData.entries()) {
          console.log(pair[0] + ': ' + pair[1]);
        }

        const response = await fetch("http://localhost:5025/api/Convert/ConvertPngToIcoV2", {
          method: "POST",
          headers: {
            Authorization: "Bearer " + token,
          },
          body: formData
        });

        // Hide progress
        convertProgress.style.display = 'none';
        convertBtn.disabled = false;

        if (response.ok) {
          if (outputAction === 'download') {
            // Handle download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            let downloadFileName = '';
            if (sourceMode === 'upload') {
              const originalName = uploadedFile.name;
              downloadFileName = originalName.substring(0, originalName.lastIndexOf('.')) + '.ico';
            } else {
              downloadFileName = fileName.replace('.png', '.ico');
            }
            
            a.download = downloadFileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            convertResult.innerHTML = `
              <div class="alert alert-success">
                <h5 class="alert-heading">
                  <i class="fa-solid fa-check-circle"></i> PNG to ICO Conversion & Download Successful!
                </h5>
                <hr>
                <p class="mb-0">
                  <strong>File:</strong> ${downloadFileName}<br>
                  <strong>Converted from:</strong> PNG<br>
                  <strong>Converted to:</strong> ICO<br>
                  <strong>Status:</strong> <span class="badge bg-success">Downloaded</span>
                </p>
              </div>
            `;
            convertResult.style.display = 'block';
            toastr.success("PNG to ICO conversion and download successful!");
          } else {
            // Save action successful
            const result = await response.json();
            convertResult.innerHTML = `
              <div class="alert alert-success">
                <h5 class="alert-heading">
                  <i class="fa-solid fa-check-circle"></i> PNG to ICO Conversion & Save Successful!
                </h5>
                <hr>
                <p class="mb-0">
                  <strong>File:</strong> ${result.fileName || 'Converted file'}<br>
                  <strong>Converted from:</strong> PNG<br>
                  <strong>Converted to:</strong> ICO<br>
                  <strong>Status:</strong> <span class="badge bg-success">Saved to folder</span>
                </p>
              </div>
            `;
            convertResult.style.display = 'block';
            toastr.success(result.message || "PNG to ICO conversion and save successful!");
          }
          
          // Reset form after a delay
          setTimeout(() => {
            resetForm();
          }, 3000);
          
        } else {
          const errorText = await response.text();
          
          // Show error result
          convertResult.innerHTML = `
            <div class="alert alert-danger">
              <h5 class="alert-heading">
                <i class="fa-solid fa-exclamation-triangle"></i> PNG to ICO Conversion Failed
              </h5>
              <p class="mb-0">${errorText || "An error occurred during PNG to ICO conversion. Please try again."}</p>
            </div>
          `;
          convertResult.style.display = 'block';
          
          toastr.error(errorText || "PNG to ICO conversion failed");
        }
      } catch (error) {
        console.error("Error during PNG to ICO conversion:", error);
        
        convertProgress.style.display = 'none';
        convertBtn.disabled = false;
        
        convertResult.innerHTML = `
          <div class="alert alert-danger">
            <h5 class="alert-heading">
              <i class="fa-solid fa-exclamation-triangle"></i> Network Error
            </h5>
            <p class="mb-0">Failed to connect to the server. Please check your connection and try again.</p>
          </div>
        `;
        convertResult.style.display = 'block';
        
        toastr.error("Network error during PNG to ICO conversion");
      }
    }

    async function loadShareFoldersToDropdown() {
      try {
        const token = localStorage.getItem("token");
        const dropdownList = document.getElementById("sharedFolderDropdownList");
        if (!dropdownList) return;

        const response = await fetch("http://localhost:5025/api/Folder/GetFolderByPermission", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        if (response.ok) {
          const folders = await response.json();

          dropdownList.innerHTML = "";

          if (folders && folders.length > 0) {
            const urlParams = new URLSearchParams(window.location.search);
            const currentFolderId = urlParams.get('id');

            folders.forEach(folder => {
              const isActive = currentFolderId === folder.id;
              const folderItem = document.createElement("a");
              folderItem.href = `../file/allFleInFolder.html?id=${folder.id}`;
              folderItem.className = "menu-item";
              folderItem.style.cssText = isActive
                ? "display: block; width: 100%; background-color: #e7f3ff; border-left: 3px solid #0d6efd; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;"
                : "display: block; width: 100%; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;";

              folderItem.innerHTML = `
                <i class="fa-solid fa-folder" style="color: ${isActive ? '#0d6efd' : '#666'}; font-size: 12px;"></i> 
                <span style="padding-left: 8px; font-size: 13px;">${folder.name || 'Unnamed Folder'}</span>
              `;

              dropdownList.appendChild(folderItem);
            });
          } else {
            dropdownList.innerHTML = `
              <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                <i class="fa-solid fa-folder-open"></i> No shared folders yet
              </div>
            `;
          }
        } else {
          dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Failed to load
            </div>
          `;
          console.error("Failed to load shared folders:", response.status);
        }
      } catch (error) {
        console.error("Error loading shared folders to dropdown:", error);
        const dropdownList = document.getElementById("sharedFolderDropdownList");
        if (dropdownList) {
          dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Error loading
            </div>
          `;
        }
      }
    }
    
    async function loadFoldersToDropdown() {
      try {
        const token = localStorage.getItem("token");
        const dropdownList = document.getElementById("folderDropdownList");

        if (!dropdownList) return;

        const response = await fetch("http://localhost:5025/api/Folder", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        if (response.ok) {
          const folders = await response.json();

          dropdownList.innerHTML = "";

          if (folders && folders.length > 0) {
            const urlParams = new URLSearchParams(window.location.search);
            const currentFolderId = urlParams.get('id');

            folders.forEach(folder => {
              const isActive = currentFolderId === folder.id;
              const folderItem = document.createElement("a");
              folderItem.href = `../file/allFleInFolder.html?id=${folder.id}`;
              folderItem.className = "menu-item";
              folderItem.style.cssText = isActive
                ? "display: block; width: 100%; background-color: #e7f3ff; border-left: 3px solid #0d6efd; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;"
                : "display: block; width: 100%; padding: 8px 10px 8px 10%; text-decoration: none; color: inherit;";

              folderItem.innerHTML = `
                <i class="fa-solid fa-folder" style="color: ${isActive ? '#0d6efd' : '#666'}; font-size: 12px;"></i> 
                <span style="padding-left: 8px; font-size: 13px;">${folder.name || 'Unnamed Folder'}</span>
              `;

              dropdownList.appendChild(folderItem);
            });
          } else {
            dropdownList.innerHTML = `
              <div class="text-center" style="padding: 10px; font-size: 12px; color: #999;">
                <i class="fa-solid fa-folder-open"></i> No folders yet
              </div>
            `;
          }
        } else {
          dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Failed to load
            </div>
          `;
          console.error("Failed to load folders:", response.status);
        }
      } catch (error) {
        console.error("Error loading folders to dropdown:", error);
        const dropdownList = document.getElementById("folderDropdownList");
        if (dropdownList) {
          dropdownList.innerHTML = `
            <div class="text-center" style="padding: 10px; font-size: 12px; color: #dc3545;">
              <i class="fa-solid fa-exclamation-triangle"></i> Error loading
            </div>
          `;
        }
      }
    }


    async function checkToken(token) {
      let url = "http://localhost:5025/api/Account/CheckToken";
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
        body: null,
      });
      if (response.ok) {
        return true;
      } else {
        return false;
      }
    }

    async function logout() {
      if (!confirm("Are you sure you want to logout?")) {
        return;
      }

      try {
        const token = localStorage.getItem("token");
        if (!token) {
          toastr.warning("No active session found");
          window.location.href = "../login.html";
          return;
        }

        const response = await fetch("http://localhost:5025/api/Account/Logout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          }
        });

        if (response.ok) {
          localStorage.removeItem("token");
          toastr.success("Logged out successfully!");
          setTimeout(() => {
            window.location.href = "../login.html";
          }, 1000);
        } else if (response.status === 401) {
          localStorage.removeItem("token");
          toastr.warning("Session expired. Redirecting to login...");
          setTimeout(() => {
            window.location.href = "../login.html";
          }, 1000);
        } else {
          const errorText = await response.text();
          toastr.error(errorText || "Logout failed. Please try again.");
        }
      } catch (error) {
        console.error("Error during logout:", error);
        localStorage.removeItem("token");
        toastr.warning("Network error. Logged out locally.");
        setTimeout(() => {
          window.location.href = "../login.html";
        }, 1500);
      }
    }

    function changePassword() {
      toastr.info("Change password feature - Coming soon!");
    }
  </script>
</body>

</html>